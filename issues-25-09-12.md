## `UV` install issue on MacOS

```R
> library(transforEmotion)
uv not found. Install uv now? [Y/n]: Y
Installing uv via Homebrew ...
Error: The following directories are not writable by your user:
/usr/local/bin
/usr/local/etc
/usr/local/sbin
/usr/local/share
/usr/local/share/man
/usr/local/share/man/man1
/usr/local/share/zsh
/usr/local/share/zsh/site-functions

You should change the ownership of these directories to your user.
  sudo chown -R Hudson /usr/local/bin /usr/local/etc /usr/local/sbin /usr/local/share /usr/local/share/man /usr/local/share/man/man1 /usr/local/share/zsh /usr/local/share/zsh/site-functions

And make sure that your user has write permission.
  chmod u+w /usr/local/bin /usr/local/etc /usr/local/sbin /usr/local/share /usr/local/share/man /usr/local/share/man/man1 /usr/local/share/zsh /usr/local/share/zsh/site-functions
uv installation did not complete or uv not on PATH.
You may need to add ~/.local/bin to PATH and restart R.
```

It worked after user manually installed `uv` via Homebrew and then

```bash
chmod u+w /usr/local/bin /usr/local/etc /usr/local/sbin /usr/local/share /usr/local/share/man /usr/local/share/man/man1 /usr/local/share/zsh /usr/local/share/zsh/site-functions
```

and 

```R
# Add ~/.local/bin to PATH for current R session
Sys.setenv(PATH = paste(Sys.getenv("PATH"), "~/.local/bin", sep = ":"))
```


Based on my analysis of the code and the issue described in issues.md, here's my proposal for solving the `uv` MacOS issue:

### Problem Analysis

The issue occurs when `uv` is being installed on MacOS via Homebrew, but the user doesn't have write permissions to `/usr/local/` directories. This is a common MacOS issue where Homebrew tries to install packages to directories that require administrator privileges.

### Proposed Solutions

#### Solution 1: Improve the Installation Logic for MacOS

Modify the `install_uv_interactive()` function in `R/reticulate_env.R` to handle MacOS installation more gracefully:

```r
install_uv_interactive <- function() {
  os <- tolower(Sys.info()[["sysname"]])  # linux, windows, darwin
  if (os == "darwin") {
    # Try installing to user directory first to avoid permission issues
    message("Installing uv to user directory ...")
    rc <- try(suppressWarnings(system("curl -fsSL https://astral.sh/uv/install.sh | sh -s -- --to ~/.local/bin")), silent = TRUE)
    
    # If that fails, try Homebrew with user prefix
    if (inherits(rc, "try-error") || rc != 0) {
      if (nzchar(Sys.which("brew"))) {
        message("Installing uv via Homebrew with user prefix...")
        rc <- try(suppressWarnings(system2("brew", c("install", "uv", "--user"))), silent = TRUE)
        
        # If that also fails, fall back to official script
        if (inherits(rc, "try-error") || rc != 0) {
          message("Homebrew user install failed. Installing uv via official script ...")
          rc <- try(suppressWarnings(system("curl -fsSL https://astral.sh/uv/install.sh | sh")), silent = TRUE)
        }
      } else {
        message("Homebrew not found. Installing uv via official script ...")
        rc <- try(suppressWarnings(system("curl -fsSL https://astral.sh/uv/install.sh | sh")), silent = TRUE)
      }
    }
    
    # Ensure ~/.local/bin is in PATH
    if (!inherits(rc, "try-error") && rc == 0) {
      local_bin <- path.expand("~/.local/bin")
      current_path <- Sys.getenv("PATH")
      if (!grepl(local_bin, current_path, fixed = TRUE)) {
        Sys.setenv(PATH = paste(local_bin, current_path, sep = ":"))
        message("Added ~/.local/bin to PATH for current session")
      }
    }
    
    return(invisible(!inherits(rc, "try-error") && rc == 0))
  } else if (os == "linux") {
    # ... existing Linux code ...
  } else if (os == "windows") {
    # ... existing Windows code ...
  } else {
    # ... existing unsupported OS code ...
  }
}
```

#### Solution 2: Better PATH Management

Enhance the `ensure_uv_available()` function to automatically add `~/.local/bin` to PATH when uv is installed:

```r
ensure_uv_available <- function(prompt = TRUE) {
  if (uv_is_available()) return(invisible(TRUE))
  
  # Check if uv exists in ~/.local/bin but not in PATH
  local_uv_path <- path.expand("~/.local/bin/uv")
  if (file.exists(local_uv_path)) {
    local_bin <- path.expand("~/.local/bin")
    current_path <- Sys.getenv("PATH")
    if (!grepl(local_bin, current_path, fixed = TRUE)) {
      Sys.setenv(PATH = paste(local_bin, current_path, sep = ":"))
      if (uv_is_available()) {
        message("Found uv in ~/.local/bin and added to PATH")
        return(invisible(TRUE))
      }
    }
  }
  
  if (!interactive() || !isTRUE(prompt)) {
    # ... existing code ...
  }
  
  ans <- tryCatch(tolower(readline("uv not found. Install uv now? [Y/n]: ")), error = function(e) "")
  if (ans %in% c("", "y", "yes")) {
    ok <- isTRUE(install_uv_interactive())
    if (ok && uv_is_available()) {
      message("uv installed successfully.")
      return(invisible(TRUE))
    } else {
      # Try to fix PATH issues
      local_bin <- path.expand("~/.local/bin")
      current_path <- Sys.getenv("PATH")
      if (!grepl(local_bin, current_path, fixed = TRUE)) {
        Sys.setenv(PATH = paste(local_bin, current_path, sep = ":"))
        if (uv_is_available()) {
          message("uv installed and added to PATH for current session.")
          message("Please add 'export PATH=\"$HOME/.local/bin:$PATH\"' to your shell profile for permanent effect.")
          return(invisible(TRUE))
        }
      }
      
      message(paste0("uv installation did not complete or uv not on PATH.\n",
                     "You may need to add ~/.local/bin to PATH and restart R."))
      return(invisible(FALSE)
    }
  } else {
    # ... existing code ...
  }
}
```

#### Solution 3: Documentation Enhancement

Update the error message in `ensure_uv_available()` to be more helpful for MacOS users:

```r
message(paste0(
  "uv not found on PATH. reticulate will fall back to a default venv if needed.\n",
  "To use uv (recommended), install it and restart R.\n",
  "- Linux: curl -LsSf https://astral.sh/uv/install.sh | sh\n",
  "- macOS (Homebrew): brew install uv\n",
  "- macOS (user install): curl -LsSf https://astral.sh/uv/install.sh | sh -s -- --to ~/.local/bin\n",
  "- Windows (winget): winget install AstralSoftware.UV\n",
  "\nOn macOS, if you encounter permission errors with Homebrew, try:\n",
  "  curl -LsSf https://astral.sh/uv/install.sh | sh -s -- --to ~/.local/bin\n",
  "Then add 'export PATH=\"$HOME/.local/bin:$PATH\"' to your ~/.zshrc or ~/.bash_profile"
))
```

### Recommendation

I recommend implementing a combination of Solutions 1 and 2:

1. Modify the installation logic to try user directory installations first on MacOS to avoid permission issues
2. Improve PATH management to automatically detect and add `~/.local/bin` when needed
3. Enhance error messages to provide clearer instructions for MacOS users

This approach would handle the most common MacOS permission issues while maintaining backward compatibility with existing installation methods.

## Confusing output of structured RAG

Something like this would make sense in the demo:


```
# Structured outputs
r1 <- rag(text = text, query = "Extract emotions", output = "json")
r2 <- rag(text = text, query = "Extract emotions", output = "table")
```

```
> r2$content
  document                           text     score
1    doc_1            Make friends easily 0.5977100
2    doc_2      Warm up quickly to others 0.5812753
3    doc_3 Feel comfortable around people 0.5859265
4    doc_4  Act comfortably around people 0.5834608
5    doc_5                Cheer people up 0.5809068
```

## rag sentemo issue

After running `rag_setemo` we have: 

```
Using device: cpu
Error: Unable to access object (object is from previous session and is now invalid)
```

## clip custom model issue

```R
> result <- image_scores("./figures/happy.png", c("happy", "sad"), model = "local-clip")
Using registered model: Locally stored fine-tuned model
Using CLIP adapter (via registry) for: /path/to/local/model
Loading CLIP model from HuggingFace: /path/to/local/model
Error in py_call_impl(callable, call_args$unnamed, call_args$named) : 
  OSError: Can't load image processor for '/path/to/local/model'. If you were trying to load it from 'https://huggingface.co/models', make sure you don't have a local directory with the same name. Otherwise, make sure '/path/to/local/model' is the correct path to a directory containing a preprocessor_config.json file
  ```

## VAD custom labels issue

```R
# Custom labels for domain-specific applications
custom_labels <- list(
  valence = list(
    positive = "Customer satisfaction and positive brand sentiment",
    negative = "Customer complaints and negative brand sentiment"
  )
)
brand_vad <- vad_scores(texts, dimensions = "valence", 
                        label_type = "custom", custom_labels = custom_labels)
Error: custom_labels must have elements named: valence, arousal, dominance
```

## issue with CLIP and HF

```r
> image_vad <- vad_scores(image_path, input_type = "image")
Using registered model: OpenAI CLIP ViT-Base/32 - General purpose vision-language model
Using CLIP adapter (via registry) for: openai/clip-vit-base-patch32
Loading CLIP model from HuggingFace: openai/clip-vit-base-patch32
Error in py_call_impl(callable, call_args$unnamed, call_args$named) : 
  OSError: There was a specific connection error when trying to load openai/clip-vit-base-patch32:
401 Client Error: Unauthorized for url: https://huggingface.co/openai/clip-vit-base-patch32/resolve/main/processor_config.json (Request ID: Root=1-68c43043-603878f12a44cf2963605c4b;883df1ff-1c88-4320-8c33-288d00ffb6af)

Invalid credentials in Authorization header
Run `reticulate::py_last_error()` for details.
```

And this:

```R
> video_results <- video_scores(
+   video = video_url,      # YouTube URL
+   classes = emotions,     # List of emotions
+   nframes = 20,           # Number of frames
+   save_video = TRUE,      # Option to save processed video
+   save_frames = TRUE,     # Option to save frames
+   video_name = 'boris_brexit',
+   start = 30,             # Start at 30 seconds into video
+   end = 120,              # End at 2 minutes
+   model = "oai-large"     # Using the larger CLIP model
+ )
Using registered model: OpenAI CLIP ViT-Large/14 - Higher capacity vision-language model
Downloading video to temp/boris_brexit.mp4
Cutting video to designated time interval...
Extracting 20 frames from 2250 total frames
Total number of saved frames: 20
Using CLIP adapter (via registry) for: openai/clip-vit-large-patch14
Loading CLIP model from HuggingFace: openai/clip-vit-large-patch14
Error in py_call_impl(callable, call_args$unnamed, call_args$named) : 
  OSError: There was a specific connection error when trying to load openai/clip-vit-large-patch14:
401 Client Error: Unauthorized for url: https://huggingface.co/openai/clip-vit-large-patch14/resolve/main/preprocessor_config.json (Request ID: Root=1-68c43102-60c88a6b279046e71c7a9d80;b32411af-f449-48fe-9692-cf0ede2c396b)

Invalid credentials in Authorization header
Run `reticulate::py_last_error()` for details.
``` 
